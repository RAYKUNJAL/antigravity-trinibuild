<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Bucket Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        button {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }

        button:hover {
            background: #dc2626;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .success {
            color: #4ade80;
        }

        .error {
            color: #f87171;
        }

        .warning {
            color: #fbbf24;
        }

        .info {
            color: #60a5fa;
        }

        .sql-block {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #ef4444;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Storage Bucket Diagnostic Tool</h1>
        <p class="subtitle">Check and fix Supabase storage configuration</p>

        <div class="input-group">
            <label>Supabase URL:</label>
            <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
        </div>

        <div class="input-group">
            <label>Supabase Anon Key:</label>
            <input type="text" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NI6...">
        </div>

        <button onclick="runDiagnostic()">Run Diagnostic</button>
        <button onclick="clearOutput()">Clear Output</button>

        <div id="output"></div>
    </div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const span = document.createElement('span');
            span.className = type;
            span.textContent = message + '\n';
            output.appendChild(span);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            output.innerHTML = '';
        }

        async function runDiagnostic() {
            clearOutput();
            log('üîç Starting Storage Diagnostic...\n', 'info');

            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();

            if (!url || !key) {
                log('‚ùå Please enter Supabase URL and Anon Key', 'error');
                return;
            }

            try {
                const { createClient } = supabase;
                const client = createClient(url, key);

                // Step 1: Check Auth
                log('Step 1: Checking Authentication...', 'info');
                const { data: { user }, error: authError } = await client.auth.getUser();

                if (authError || !user) {
                    log('‚ùå Not authenticated', 'error');
                    log('   Please log into your app first, then run this again\n', 'warning');
                    return;
                }

                log(`‚úÖ Authenticated as: ${user.email}`, 'success');
                log(`   User ID: ${user.id}\n`, 'info');

                // Step 2: List Buckets
                log('Step 2: Listing Storage Buckets...', 'info');
                const { data: buckets, error: listError } = await client.storage.listBuckets();

                if (listError) {
                    log(`‚ö†Ô∏è  Cannot list buckets: ${listError.message}`, 'warning');
                    log('   (This is normal if RLS restricts bucket listing)\n', 'info');
                } else {
                    log(`‚úÖ Found ${buckets?.length || 0} bucket(s):`, 'success');
                    buckets?.forEach(b => {
                        log(`   - ${b.id} (public: ${b.public})`, 'info');
                    });
                    log('');

                    const hasSiteAssets = buckets?.some(b => b.id === 'site-assets');
                    if (!hasSiteAssets) {
                        log('‚ö†Ô∏è  site-assets bucket NOT found in list', 'warning');
                    }
                }

                // Step 3: Test Upload
                log('Step 3: Testing Upload to site-assets...', 'info');
                const testFile = new File(['diagnostic test'], `test_${Date.now()}.txt`, { type: 'text/plain' });

                const { data: uploadData, error: uploadError } = await client.storage
                    .from('site-assets')
                    .upload(`diagnostic/${testFile.name}`, testFile, {
                        cacheControl: '3600',
                        upsert: true
                    });

                if (uploadError) {
                    log('‚ùå Upload FAILED', 'error');
                    log(`   Error: ${uploadError.message}`, 'error');
                    log(`   Status: ${uploadError.statusCode || 'N/A'}\n`, 'error');

                    if (uploadError.message.toLowerCase().includes('not found') ||
                        uploadError.message.toLowerCase().includes('bucket')) {

                        log('üîß SOLUTION: Create the bucket', 'warning');
                        log('   Copy this SQL and run in Supabase Dashboard ‚Üí SQL Editor:\n', 'info');

                        const sql = `-- Create site-assets bucket
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
    'site-assets', 
    'site-assets', 
    true, 
    524288000,
    ARRAY['video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo', 'video/avi', 'image/jpeg', 'image/png', 'image/webp']
)
ON CONFLICT (id) DO UPDATE SET
    public = true,
    file_size_limit = 524288000;

-- Allow public read
CREATE POLICY IF NOT EXISTS "Public Access site-assets"
ON storage.objects FOR SELECT
USING ( bucket_id = 'site-assets' );

-- Allow authenticated upload
CREATE POLICY IF NOT EXISTS "Authenticated users can upload site-assets"
ON storage.objects FOR INSERT
WITH CHECK ( bucket_id = 'site-assets' AND auth.role() = 'authenticated' );`;

                        log(sql, 'info');
                        navigator.clipboard.writeText(sql).then(() => {
                            log('\n‚úÖ SQL copied to clipboard!', 'success');
                        });

                    } else if (uploadError.message.toLowerCase().includes('policy') ||
                        uploadError.message.toLowerCase().includes('permission')) {

                        log('üîß SOLUTION: Fix RLS policies', 'warning');
                        log('   The bucket exists but upload policy is missing.\n', 'info');

                        const sql = `-- Fix upload policy
CREATE POLICY IF NOT EXISTS "Authenticated users can upload site-assets"
ON storage.objects FOR INSERT
WITH CHECK ( bucket_id = 'site-assets' AND auth.role() = 'authenticated' );`;

                        log(sql, 'info');
                    }

                } else {
                    log('‚úÖ Upload SUCCESSFUL!', 'success');
                    log(`   Path: ${uploadData.path}`, 'info');

                    // Cleanup
                    await client.storage.from('site-assets').remove([`diagnostic/${testFile.name}`]);
                    log('   (Test file cleaned up)\n', 'info');

                    log('üéâ SUCCESS! site-assets bucket is configured correctly!', 'success');
                    log('   You can now upload videos.\n', 'success');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Auto-fill from localStorage if available
        window.addEventListener('load', () => {
            const savedUrl = localStorage.getItem('supabaseUrl');
            const savedKey = localStorage.getItem('supabaseKey');

            if (savedUrl) document.getElementById('supabaseUrl').value = savedUrl;
            if (savedKey) document.getElementById('supabaseKey').value = savedKey;

            // Save on change
            document.getElementById('supabaseUrl').addEventListener('blur', (e) => {
                localStorage.setItem('supabaseUrl', e.target.value);
            });
            document.getElementById('supabaseKey').addEventListener('blur', (e) => {
                localStorage.setItem('supabaseKey', e.target.value);
            });
        });
    </script>
</body>

</html>